{% extends "base.html" %}
{% load wagtailcore_tags static embed_video_tags wagtailimages_tags %}
{% block content %}
    <div class="flex flex-col text-white gap-y-8 mb-4">
        <div>
            <img class="object-cover w-full h-96" src="{{ page.cover_img_url }}" alt="Cover Img"
                 onerror="this.onerror=null;this.src={% static "images/placeholder.png" %}">
        </div>

        <div class="flex flex-col w-11/12 mx-auto bg-card-bg rounded-xl p-4 gap-y-8  hover:drop-shadow-bf2042-3 transition duration-100 ease-in">
            <div class="text-6xl md:text-7xl lg:text-8xl">{{ page.title|title }}</div>
            <div class="flex flex-row gap-x-2">
                {% if page.featured %}
                    <a class="text-sm bg-hover-bg-light ho w-max rounded-full hover:border-bf2042-3 hover:drop-shadow-bf2042-3-sm transition duration-100 ease-in" href="/experiences/featured">
                        <div class="px-2 ">
                            <img src="{% static 'images/icons/featured.png' %}" class="w-6 inline-block">
                            Featured
                        </div>
                    </a>
                {% endif %}
                {% for cat in page.categories.all %}
                    <a class="text-sm bg-hover-bg-light ho w-max rounded-full hover:border-bf2042-3 hover:drop-shadow-bf2042-3-sm transition duration-100 ease-in" href="/experiences/?category={{ cat.name }}">
                        <div class="px-2 ">
                            {% image cat.icon width-24 class="inline-block" %}
                            {{ cat.name }}
                        </div>
                    </a>
                {% endfor %}
            </div>
            <div class="flex flex-row gap-x-1">
                <div class="text-sm">
                    <div class="inline-block text-xs text-bg-light align-middle">Created by</div>
                    <div class="inline-block bg-hover-bg-light rounded-full px-2 hover:bg-bf2042-2 transition duration-100 ease-in">
                        {% with page.owner.socialaccount_set.all.0 as owner %}
                            <a href="/users/{{ owner.uid }}">
                                <div class="hidden md:inline-block md:w-6">
                                    <img class="w-6 h-full rounded-full inline-block" src="{% if owner.extra_data.avatar %} {{ owner.get_avatar_url }} {% else %} {% static 'images/default_discord_avatar.png' %}{% endif %}" alt="pfp">
                                </div>

                                {{ owner.extra_data.username }}
                            </a>
                        {% endwith %}
                    </div>
                </div>
                <div class="text-sm">
                    <div class="block text-xs text-bg-light md:inline-block">on</div>
                    {{ page.first_published_at }}</div>
                <div class="text-sm">
                    <div class="block text-xs text-bg-light md:inline-block">last updated on</div>
                    {{ page.last_published_at }}</div>
            </div>
            <div class="flex flex-col bg-default w-full rounded-xl px-2 min-h-fit">
                {% if page.exp_url %}
                    <div class="flex flex-row gap-x-2">
                        <div class="font-mono">Experience Url</div>
                        <div class="font-bold text-ellipsis">
                            <a class="hidden md:block hover:text-bf2042-4 transition duration-200 ease-in-out hover:cursor-alias"
                               href="{{ page.exp_url }}" target="_blank"> {{ page.exp_url }}
                            </a>
                            <span id="expUrlSpan" class="hover:text-bf2042-4 transition duration-200 ease-in-out hover:cursor-alias md:hidden" expurl="{{ page.exp_url }}">
                                Tap to copy
                            </span>
                        </div>
                    </div>
                {% endif %}

                {% if page.code %}
                    <div class="flex flex-row gap-x-2">
                        <div class="font-mono">Experience Share Code</div>
                        <div class="font-bold hover:text-bf2042-4 transition duration-200 ease-in-out"> {{ page.code }}</div>
                    </div>
                {% endif %}
                {% if page.no_players %}
                    <div class="flex flex-row gap-x-2">
                        <div class="font-mono">Human Players</div>
                        <div class="font-bold hover:text-bf2042-4 transition duration-200 ease-in-out"> {{ page.no_players }} </div>
                    </div>
                {% endif %}
                {% if  page.no_bots %}
                    <div class="flex flex-row gap-x-2">
                        <div class="font-mono">No. Bots</div>
                        <div class="font-bold hover:text-bf2042-4 transition duration-200 ease-in-out"> {{ page.no_bots }} </div>
                    </div>
                {% endif %}
            </div>
            <div class="flex flex-row flex-wrap	">
                {% for tag in page.tags.all|slice:"0:5" %}
                    <a href="/experiences/?tag={{ tag }}" class="border bg-discord-light-dark border-2 text-white whitespace-nowrap border-1/2  border-card-bg rounded-lg px-2 py-0 mb-1 hover:border-bf2042-3 hover:drop-shadow-bf2042-3-sm transition duration-100 ease-in ">{{ tag|title }}</a>
                {% endfor %}
            </div>
            <div class="font-sans text-justify text-bg-light rounded-xl px-1 hover:text-gray-200  transition duration-200 ease-in-out">{{ page.description }}</div>


            <div id="mapsRotationContainer" class="flex flex-wrap flex-col gap-y-4">
                <div class="text-2xl text-white">Maps</div>
                <div><button id="showMapsRotation" class="bg-hover-bg-light hover:bg-bf2042-2 text-bf2042-4 px-2 rounded">Show Maps Rotation</button></div>
                <div id="mapsRotation" class="flex flex-wrap gap-2 relative"></div>
            </div>

            {% if page.vid_url|length > 0 %}
                <div class="w-full h-[42rem]">
                    {% video page.vid_url '100% x 100%' %}
                </div>
            {% endif %}
        </div>
    </div>

{% endblock content %}

{% block extra_js %}
    <script type="text/javascript">
    let mapsShown = false;
    $('#showMapsRotation').on('click touch', function () {
        const val = $(this).text(),
            mapRotation = $('#mapsRotation');
        if (val === "Show Maps Rotation"){
            $(this).text("Hide Maps Rotation");
            mapRotation.show(200);
        } else {
            $(this).text("Show Maps Rotation");
            mapRotation.hide(200);
        }
        populateMapsRotation();
    });

    function populateMapsRotation(){
        const mapRotation = document.getElementById('mapsRotation');
        if (!mapsShown) {
            const playgroundId = {% if page.exp_url %}"{{ page.exp_url | expCode }}"{% else %}null{% endif %},
                expCode = {% if page.code %}"{{ page.code }}"{% else %}null{% endif %};

            let queryParam;
            if (playgroundId) {
                queryParam = `playgroundid=${playgroundId}`;
            } else if (expCode) {
                queryParam = `experiencecode=${expCode}`
            }
            if (queryParam) {
                fetch(`https://api.gametools.network/bf2042/playground/?${queryParam}`).then(resp => resp.json().then(resp_json => {
                    let maps = resp_json['validatedPlayground']['mapRotation']['maps'];
                    console.log(maps);
                    maps.forEach(function (map) {
                        console.log(map);
                        const root = document.createElement('div'),
                            img = document.createElement('img'),
                            infoContainer = document.createElement('div'),
                            info = document.createElement('div'),
                            mapName = document.createElement('div');
                        root.className = "h-36 w-88 rounded-lg relative";
                        img.className = "object-contain w-full h-full rounded-lg";
                        infoContainer.className = "absolute bg-hover-bg-light/90 w-full h-16 inset-x-0 bottom-0 rounded-b-lg p-2"
                        info.className = "flex flex-col";
                        mapName.className = "max-w-full h-6 truncate";
                        let mapSize;
                        if ("location" in map){
                            mapSize = document.createElement('div');
                            const span = document.createElement('span'),
                                location = map['location'];
                            mapSize.className = "max-w-full";
                            if (location === "ModBuilderCustom2"){
                                span.textContent = "Large";
                            } else if (location === "ModBuilderCustom1") {
                                span.textContent = "Normal";
                            } else {
                                span.textContent = "Small";
                            }
                            mapSize.textContent = "Map Size "
                            mapSize.appendChild(span);
                        }
                        img.src = map['image'];
                        mapName.textContent = map['mapname'];
                        info.appendChild(mapName)
                        if (mapSize) {
                            info.appendChild(mapSize);
                        }
                        infoContainer.appendChild(info);
                        root.appendChild(img);
                        root.appendChild(infoContainer);
                        mapRotation.appendChild(root);
                    })
                    mapsShown = true;
                    mapRotation.scrollIntoView();
                }))
            }
        }
    }
    </script>
{#https://api.gametools.network/bf2042/playground/?playgroundid=45e436e0-4cf7-11ec-be7b-76c50778a53a#}
{##}
{#                        <div class="h-36 w-88 rounded-lg relative">#}
{#                        <img class="object-contain w-full h-full rounded-lg" src="https://portal.battlefield.com/1916651/assets/images/maps/Map_Art_BF2042_IRR_S.jpg" alt="test">#}
{#                        <div class="absolute bg-hover-bg-light/90 w-full h-16 inset-x-0 bottom-0 rounded-b-lg p-2">#}
{#                            <div class="flex flex-col">#}
{#                                <div class="max-w-full h-6 truncate">Breakaway</div>#}
{#                                <div class="max-w-full">Map Size <span>Large</span></div>#}
{#                            </div>#}
{#                        </div>#}
{#                    </div>#}

{% endblock %}